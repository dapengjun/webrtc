<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script>
        var signalingChannel = new SignalingChannel();
        var configuration = { "iceServers": [{ "url": "stun:stun.example.org" }] };
        var pc;

        // call start() to initiate
        function start() {
            pc = new RTCPeerConnection(configuration);

            // send any ice candidates to the other peer
            pc.onicecandidate = function (evt) {
                if (evt.candidate)
                    signalingChannel.send(JSON.stringify({ "candidate": evt.candidate }));
            };

            // let the "negotiationneeded" event trigger offer generation
            pc.onnegotiationneeded = function () {
                pc.createOffer().then(function (offer) {
                    return pc.setLocalDescription(offer);
                })
                        .then(function () {
                            // send the offer to the other peer
                            signalingChannel.send(JSON.stringify({ "sdp": pc.localDescription }));
                        })
                        .catch(logError);
            };

            // once remote stream arrives, show it in the remote video element
            pc.onaddstream = function (evt) {
                remoteView.srcObject = evt.stream;
            };

            // get a local stream, show it in a self-view and add it to be sent
            navigator.mediaDevices.getUserMedia({ "audio": true, "video": true }, function (stream) {
                selfView.srcObject = stream;
                pc.addStream(stream);
            }, logError);
        }

        signalingChannel.onmessage = function (evt) {
            if (!pc)
                start();

            var message = JSON.parse(evt.data);
            if (message.sdp) {
                var desc = new RTCSessionDescription(message.sdp);

                // if we get an offer, we need to reply with an answer
                if (desc.type == "offer") {
                    pc.setRemoteDescription(desc).then(function () {
                        return pc.createAnswer();
                    })
                            .then(function (answer) {
                                return pc.setLocalDescription(answer);
                            })
                            .then(function () {
                                signalingChannel.send(JSON.stringify({ "sdp": pc.localDescription }));
                            })
                            .catch(logError);
                } else
                    pc.setRemoteDescription(desc).catch(logError);
            } else
                pc.addIceCandidate(new RTCIceCandidate(message.candidate)).catch(logError);
        };

        function logError(error) {
            log(error.name + ": " + error.message);
        }
    </script>
</head>
<body>

</body>
</html>